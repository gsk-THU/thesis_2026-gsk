# 已解决

## 问题 1：缺少构建配置文件

**问题描述：**
执行 `ostool run qemu` 时报错：
```
Error: can not open config file: /home/gsk/thesis_2026-gsk/starryos_rk3588/StarryOS/.build.toml
```

**原因：**
ostool 需要构建配置文件来了解如何编译内核，但项目中缺少 `.build.toml` 文件。

**解决方案：**
创建 `/home/gsk/thesis_2026-gsk/starryos_rk3588/StarryOS/.build.toml` 文件，内容如下：
```toml
[system.Custom]
build_cmd = "make aarch64-build LOG=info FEATURES=ext4,driver-virtio-blk"
elf_path = "StarryOS_aarch64-dyn.elf"
to_bin = true
```

---

## 问题 2：ostool 未安装

**问题描述：**
执行 `ostool run qemu` 时系统提示找不到 ostool 命令。

**原因：**
系统中没有安装 ostool 工具。

**解决方案：**
使用 cargo 安装 ostool：
```bash
cargo install ostool
```

---

## 问题 3：QEMU 未安装

**问题描述：**
运行 ostool 时提示找不到 qemu-system-aarch64 命令。

**原因：**
系统中没有安装 QEMU 系统模拟器。

**解决方案：**
安装 QEMU：
```bash
sudo apt install qemu-system-arm
```

---

## 问题 4：缺少块设备（磁盘镜像）

**问题描述：**
系统启动后报错：
```
panicked at arceos/modules/axruntime/src/lib.rs:213:22:
No block device found!
```

**原因：**
QEMU 没有配置虚拟块设备，StarryOS 无法找到磁盘来挂载根文件系统。

**解决方案：**

1. 下载根文件系统镜像：
```bash
cd /home/gsk/thesis_2026-gsk/starryos_rk3588/StarryOS
make ARCH=aarch64 img
```

2. 配置 QEMU 启动参数，添加 virtio-blk 设备：
```bash
make aarch64 LOG=info FEATURES=ext4,driver-virtio-blk
```

---

## 问题 5：磁盘镜像文件系统格式不匹配

**问题描述：**
系统检测到块设备（大小 1048576KB = 1GB），但在挂载时报错：
```
[  0.458498 0:2 fatfs::boot_sector:452] Invalid boot sector signature: expected [0x55, 0xAA] but got [0, 0]
panicked at arceos/modules/axfs-ng/src/fs/fat/fs.rs:39:18:
failed to initialize FAT filesystem: CorruptedFileSystem
```

**原因分析：**

1. StarryOS 默认使用 FAT32 文件系统（通过 `axfs-ng` crate 的 `fat` feature）
2. 下载的 `rootfs-aarch64.img` 镜像实际上是 EXT4 文件系统格式
3. 系统尝试将 EXT4 格式的镜像作为 FAT 文件系统挂载，导致校验失败

验证镜像格式：
```bash
file arceos/disk.img
# 输出: Linux rev 1.0 ext4 filesystem data
```

**解决方案：**

1. 修改 `/home/gsk/thesis_2026-gsk/starryos_rk3588/StarryOS/Cargo.toml`，添加 ext4 功能：
```toml
[features]
default = []
qemu = [
    "axfeat/driver-virtio-blk",
    "axfeat/driver-virtio-net",
    "axfeat/driver-virtio-gpu",
    "axfeat/display",
    "axfeat/driver-virtio-input",
    "axfeat/input",
    "starry-api/input",
    "axfeat/defplat",
    "axfeat/fs-times",
    "starry-api/dev-log",
]
ext4 = ["axfs-ng/ext4"]  # 新增此行
```

2. 重新编译并运行，启用 ext4 功能：
```bash
make aarch64 LOG=info FEATURES=ext4,driver-virtio-blk
```

**技术说明：**

`axfs-ng` crate 支持两种文件系统：
- **FAT**（默认）：通过 `fatfs` 依赖实现
- **EXT4**：通过 `lwext4_rust` 依赖实现

文件系统选择逻辑位于 `arceos/modules/axfs-ng/src/fs/mod.rs`：
```rust
pub fn new_default(dev: AxBlockDevice) -> VfsResult<Filesystem> {
    cfg_if! {
        if #[cfg(feature = "ext4")] {
            ext4::Ext4Filesystem::new(dev)
        } else if #[cfg(feature = "fat")] {
            Ok(fat::FatFilesystem::new(dev))
        } else {
            panic!("No filesystem feature enabled");
        }
    }
}
```

通过启用 `ext4` feature，系统会优先使用 EXT4 文件系统，从而正确挂载下载的根文件系统镜像。

---

## 问题 6：ostool 配置格式不正确

**问题描述：**
使用 ostool 运行时，QEMU 命令没有包含 virtio-blk 设备参数，导致 "No block device found" 错误。

**原因：**
`.project.toml` 配置文件格式不符合 ostool 的预期格式。

**解决方案：**

修改 `/home/gsk/thesis_2026-gsk/starryos_rk3588/StarryOS/.project.toml`，使用正确的 ostool 配置格式：
```toml
[compile]
target = "aarch64-unknown-none-softfloat"

[compile.build.Custom]
shell = ["make aarch64-build LOG=info FEATURES=ext4,driver-virtio-blk"]
kernel = "StarryOS_aarch64-dyn.bin"

[qemu]
machine = "virt"
cpu = "cortex-a57"
graphic = false
args = "-drive file=arceos/disk.img,if=none,format=raw,id=hd0 -device virtio-blk-device,drive=hd0"
```

---

## 最终解决方案总结

要成功在 QEMU 中运行 StarryOS，需要执行以下步骤：

1. **安装必要工具：**
   ```bash
   cargo install ostool
   sudo apt install qemu-system-arm
   ```

2. **准备构建配置：**
   - 创建 `.build.toml`（包含构建命令）
   - 创建 `.project.toml`（包含 QEMU 配置）

3. **下载根文件系统：**
   ```bash
   make ARCH=aarch64 img
   ```

4. **启用 EXT4 支持：**
   - 在 `Cargo.toml` 中添加 `ext4 = ["axfs-ng/ext4"]`

5. **编译并运行：**
   ```bash
   make aarch64 LOG=info FEATURES=ext4,driver-virtio-blk
   ```

## 相关文件路径

- 项目目录：`/home/gsk/thesis_2026-gsk/starryos_rk3588/StarryOS`
- 构建配置：`.build.toml`
- 项目配置：`.project.toml`
- 依赖配置：`Cargo.toml`
- 根文件系统镜像：`arceos/disk.img`
- 文件系统模块：`arceos/modules/axfs-ng/`

# 待解决

## 硬件缺失
os部署到orangepi上时，发现没有tf卡，已采购，还没送到

## 文档过于粗略
目前的这个技术报告对于部署的部分写的比较粗略，这一周在qemu中部署就遇到了很多问题，预期下周上板可能还会有很多需要解决的地方，或许需要更详细文档？